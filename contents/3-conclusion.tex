\conclusion

Таким образом, в ходе прохождения практики был разработан новый протокол подключения анонимных реплик, удовлетворяющий требованиям команды CDC. Он выглядит следующим образом:

\begin{enumerate}
    \item Анонимая реплика отправляет IPROTO\_FETCH\_SNAPSHOT, сообщая мастеру, что она хочет реплицироваться с него. В этот запрос может быть включены следующие опции:
    \begin{enumerate}
        \item IPROTO\_CURSOR - реплика хочет использовать файловый JOIN для возможности продолжения подключения в случае разрыва подключения.
        \item IPROTO\_IS\_PERSISTENT\_GC - необходимо создать анонимного GC consumer и сохранять xlog файлы для данной реплики.
        \item IPROTO\_SPACE\_NAME\_FILTER - поток репликации должен быть фильтрованным. Требуются только частичные данные.
    \end{enumerate}
    \item В ответ мастер посылает vclock read-view или файла снапшота (в зависимости от IPROTO\_CURSOR). Мастер создает анонимный GC consumer, если опция IPROTO\_IS\_PERSISTENT\_GC равен true.
    \item Мастер начинает пересылку данных. Если IPROTO\_SPACE\_NAME\_FILTER указан, то данные фильтруются на стороне сервера и посылаются частично.
    \item Реплика посылает IPROTO\_SUBSCRIBE, указывая необходимость GC consumer и фильтрации потока.
\end{enumerate}

В любой момент времени процесс подключения может быть разорван и продолжен с того же момента. Ошибки удаления файлов xlog больше не возникают, так как теперь есть возможность их сохранения для анонимных реплик. Нагрузка на CDC реплики была снижена, так как теперь им больше не приходится самостоятельно обрабатывать фильтрацию репликации.
